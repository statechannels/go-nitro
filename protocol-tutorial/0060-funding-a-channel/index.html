
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.6">
    
    
      
        <title>Funding a channel - Nitro State Channel Framework</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="statechannels.org" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#funding-a-channel" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Nitro State Channel Framework" class="md-header__button md-logo" aria-label="Nitro State Channel Framework" data-md-component="logo">
      
  <img src="../../assets/mstile-144x144.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nitro State Channel Framework
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Funding a channel
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/statechannels/go-nitro" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Nitro Channels
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../faqs/" class="md-tabs__link">
      FAQs
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../research-papers/" class="md-tabs__link">
      Research papers
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../applications/0010-filecoin/" class="md-tabs__link">
        Applications
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../0010-states-channels/" class="md-tabs__link md-tabs__link--active">
        Protocol tutorial
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Nitro State Channel Framework" class="md-nav__button md-logo" aria-label="Nitro State Channel Framework" data-md-component="logo">
      
  <img src="../../assets/mstile-144x144.png" alt="logo">

    </a>
    Nitro State Channel Framework
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/statechannels/go-nitro" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Nitro Channels
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faqs/" class="md-nav__link">
        FAQs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../research-papers/" class="md-nav__link">
        Research papers
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Applications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Applications" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Applications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../applications/0010-filecoin/" class="md-nav__link">
        Filecoin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../applications/0020-web3torrent/" class="md-nav__link">
        Web3Torrent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../applications/0030-others/" class="md-nav__link">
        Others
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Protocol tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Protocol tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Protocol tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0010-states-channels/" class="md-nav__link">
        States & Channels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0020-execution-rules/" class="md-nav__link">
        Execution Rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0030-outcomes/" class="md-nav__link">
        Outcomes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0040-lifecycle-of-a-channel/" class="md-nav__link">
        Lifecycle of a state channel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0050-precautions-and-limits/" class="md-nav__link">
        Precautions and Limits
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Funding a channel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Funding a channel
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fund-with-an-on-chain-deposit" class="md-nav__link">
    Fund with an on-chain deposit
  </a>
  
    <nav class="md-nav" aria-label="Fund with an on-chain deposit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#outcome-priority" class="md-nav__link">
    Outcome priority
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fund-from-an-existing-channel" class="md-nav__link">
    Fund from an existing channel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fund-virtually" class="md-nav__link">
    Fund virtually
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0070-finalizing-a-channel/" class="md-nav__link">
        Finalizing a channel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0080-defunding-a-channel/" class="md-nav__link">
        Defunding a channel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fund-with-an-on-chain-deposit" class="md-nav__link">
    Fund with an on-chain deposit
  </a>
  
    <nav class="md-nav" aria-label="Fund with an on-chain deposit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#outcome-priority" class="md-nav__link">
    Outcome priority
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fund-from-an-existing-channel" class="md-nav__link">
    Fund from an existing channel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fund-virtually" class="md-nav__link">
    Fund virtually
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/statechannels/go-nitro/edit/master/docs/protocol-tutorial/0060-funding-a-channel.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="funding-a-channel">Funding a channel</h1>
<p>Early on in the <a href="../0040-lifecycle-of-a-channel/">lifecycle</a> of a state channel -- i.e. after exchanging some setup states, but before executing any application logic -- participants will want to "fund it". They will stake assets on the channel so that the state updates are meaningful. The simplest way to do this is with an on chain deposit; a more advanced possibility is fund a new channel from an existing funded channel.</p>
<h2 id="fund-with-an-on-chain-deposit">Fund with an on-chain <code>deposit</code></h2>
<p>The deposit method allows ETH or ERC20 tokens to be escrowed against a channel.
We have the following call signature:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">function</span><span class="w"> </span><span class="nv">deposit</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">asset</span><span class="p">,</span><span class="w"> </span><span class="kt">bytes32</span><span class="w"> </span><span class="nv">destination</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">expectedHeld</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"></span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There are a few rules to obey when calling <code>deposit</code>. Firstly, <code>destination</code> must NOT be  an <a href="../0030-outcomes/#destinations">external destination</a>. Secondly, the on-chain holdings for <code>destination</code> must be greater than or equal to <code>expectedHeld</code>. Thirdly, the holdings for <code>destination</code> must be less than the sum of the amount expected to be held and the amount declared in the deposit.</p>
<p>The first rule prevents funds being escrowed against something other than a channelId: funds may only be unlocked from channels, so you shouldn't deposit into anything else. The second rule prevents loss of funds: since holdings are paid out in preferential order, depositing before a counterparty has deposited implies that they can withdraw your funds. The check is performed in the same transaction as the deposit, making this safe even in the event of a chain re-org that reverts a previous participant's deposit. The third rule prevents the deposit of uneccessary funds: if my aim was to increase the holdings to a certain level, but they are already at or above that level, then I want my deposit to transaction revert.</p>
</div>
<p>If we are depositing ETH, we must remember to send the right amount of ETH with the transaction, and to set the <code>asset</code> parameter to the zero address.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ethers</span><span class="p">,</span><span class="w"> </span><span class="nx">constants</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;ethers&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">randomChannelId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@statechannels/nitro-protocol&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="cm">/*</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="cm">      Get an appropriate representation of 1 wei, and</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="cm">      use randomChannelId() as a dummy channelId.</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="cm">      WARNING: don&#39;t do this in the wild: you won&#39;t be able to recover these funds.</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="cm">  */</span><span class="w"></span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kd">const</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseUnits</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wei&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kd">const</span><span class="w"> </span><span class="nx">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">randomChannelId</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="cm">/*</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="cm">    Attempt to deposit 1 wei against the channel id we created.</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="cm">    Inspect the error message in the console for a hint about the bug on the next line </span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="cm">*/</span><span class="w"></span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="kd">const</span><span class="w"> </span><span class="nx">expectedHeld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="kd">const</span><span class="w"> </span><span class="nx">tx0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NitroAdjudicator</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">  </span><span class="nx">constants</span><span class="p">.</span><span class="nx">AddressZero</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">  </span><span class="nx">destination</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">  </span><span class="nx">expectedHeld</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">  </span><span class="nx">amount</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">  </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">amount</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="p">);</span><span class="w"></span>
</code></pre></div>
<ol>
<li>This magic value declares that this is a native token deposit (e.g. ETH).</li>
</ol>
<p>Otherwise, if we are depositing ERC20 tokens, we must remember to <a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20#IERC20-approve-address-uint256-"><code>approve</code></a> the NitroAdjudicator for enough tokens before making the deposit, and then call deposit with the ERC20 token contract address as the first parameter (instead of the zero address).</p>
<h3 id="outcome-priority">Outcome priority</h3>
<p><img align="left" alt="Outcome priority" src="../outcome-priority.png" />
In Nitro, it is possible for a channel to be underfunded, exactly funded or overfunded at different points in time. Particularly during depositing, there are fewer funds held against the channel than are allocated by it (i.e. it is underfunded). If a channel were to finalize and be liquidated when underfunded (something which could happen), the funds would be paid out in priority order. This implies that depositing safely requires an understanding of that priority order -- in essence, participants should not deposit until those with higher priority have had their deposits confirmed.</p>
<h2 id="fund-from-an-existing-channel">Fund from an existing channel</h2>
<p>In most cases, there should be no need to pay the cost and latency of funding on chain. All it takes to fund a second channel (say, <code>X</code>) <strong>off-chain</strong> from a first (sa,y <code>L</code>) is to make a state update in <code>L</code>. The participants of <code>L</code> can collaborate to support a state with a modififed <a href="../0030-outcomes/"><code>outcome</code></a>. This is particularly straightforward if the first channel is running the <a href="../0010-states-channels/#consensusapp"><code>ConsensusApp</code></a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>In this context, the channel <code>L</code> is known as a <strong>ledger channel</strong>.</p>
</div>
<p>Take for example an initial funding tree like this:</p>
<pre class="mermaid"><code>graph TD;
linkStyle default interpolate basis;
ETHAssetHolder( )
ledger((L))
me(( )):::me
hub(( )):::hub
ETHAssetHolder--&gt;|10|ledger;
ledger--&gt;|5|me;
ledger--&gt;|5|hub;
classDef me fill:#4287f5
classDef hub fill:#85e69f
classDef bob fill:#d93434</code></pre>
<p>The diagram shows on-chain funding of <code>10</code> for <code>L</code>, which initially allocates <code>5</code> to each participant. The participants propose and countersign a modified outcome like so:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Typescript</label><label for="__tabbed_1_2">Go</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nx">Exit</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nx">SingleAssetExit</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nx">NullAssetMetadata</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@statechannels/exit-format&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ethExit</span><span class="o">:</span><span class="w"> </span><span class="kt">SingleAssetExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span><span class="nx">asset</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x0&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span><span class="nx">assetMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">NullAssetMetadata</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">  </span><span class="nx">allocations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x00000000000000000000000096f7123E3A80C9813eF50213ADEd0e4511CB820f&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Alice</span><span class="w"></span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x02&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
</span><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.simple</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x0000000000000000000000000737369d5F8525D039038Da1EdBAC4C4f161b949&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Bob</span><span class="w"></span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x02&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (2)</span><span class="w"></span>
</span><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.simple</span><span class="p">,</span><span class="w"> </span><span class="c1">// a regular ETH transfer</span><span class="w"></span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="hll"><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span><span class="w"></span>
</span><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="hll"><span class="w">      </span><span class="c1">// The channel id of the second channel:</span><span class="w"></span>
</span><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="hll"><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xC4f161b9490737369d5F8525D039038Da1EdBAC4&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x06&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="hll"><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.simple</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="hll"><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="hll"><span class="w">    </span><span class="p">},</span><span class="w"></span>
</span><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">  </span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="kd">const</span><span class="w"> </span><span class="nx">exit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">ethExit</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<ol>
<li>This amount was decremented by 3.</li>
<li>This amount was decremented by 3.</li>
<li>This allocation was appended.</li>
</ol>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="w">  </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="s">&quot;math/big&quot;</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="s">&quot;github.com/ethereum/go-ethereum/common&quot;</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="s">&quot;github.com/statechannels/go-nitro/channel/state/outcome&quot;</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="s">&quot;github.com/statechannels/go-nitro/types&quot;</span><span class="w"></span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ethExit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">SingleAssetExit</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">      </span><span class="nx">Allocations</span><span class="p">:</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocations</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0x00000000000000000000000096f7123E3A80C9813eF50213ADEd0e4511CB820f&quot;</span><span class="p">)),</span><span class="w"></span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
</span><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">        </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0x0000000000000000000000000737369d5F8525D039038Da1EdBAC4C4f161b949&quot;</span><span class="p">)),</span><span class="w"></span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="c1">// (2)</span><span class="w"></span>
</span><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">        </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="hll"><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span><span class="w"></span>
</span><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="hll"><span class="w">          </span><span class="c1">// The channel id of the second channel:</span><span class="w"></span>
</span><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="hll"><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0xC4f161b9490737369d5F8525D039038Da1EdBAC4&quot;</span><span class="p">)),</span><span class="w"></span>
</span><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"></span>
</span><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="hll"><span class="w">        </span><span class="p">},</span><span class="w"></span>
</span><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">      </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">exit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Exit</span><span class="p">{{</span><span class="nx">ethExit</span><span class="p">}}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>This amount was decremented by 3.</li>
<li>This amount was decremented by 3.</li>
<li>This allocation was appended.</li>
</ol>
</div>
</div>
</div>
<p>Bringing the funding graph to a state like this:</p>
<pre class="mermaid"><code>graph TD;
linkStyle default interpolate basis;
ETHAssetHolder( )
ledger((L))
channel((X))
me(( )):::me
hub(( )):::hub
ETHAssetHolder--&gt;|10|ledger;
ledger--&gt;|2|me;
ledger--&gt;|2|hub;
ledger--&gt;|6|channel;
classDef me fill:#4287f5
classDef hub fill:#85e69f
classDef bob fill:#d93434</code></pre>
<h2 id="fund-virtually">Fund virtually</h2>
<p>It is possible to virtually fund a channel with a counterparty via two or more channels which constitute an indirect pre-existing connection with that counterparty.</p>
<p>Take for example an initial funding tree like this:</p>
<pre class="mermaid"><code>graph TD;
linkStyle default interpolate basis;
ETHAssetHolder( )
ledgerL((L))
ledgerM((M))
ledgerR((R))
me((A)):::me
hub1((I1)):::hub1
hub2((I2)):::hub2
counterparty((B)):::bob
ETHAssetHolder--&gt;|10|ledgerL;
ETHAssetHolder--&gt;|10|ledgerM;
ETHAssetHolder--&gt;|10|ledgerR;
ledgerL--&gt;|5|me;
ledgerL--&gt;|5|hub1;
ledgerM--&gt;|5|hub1;
ledgerM--&gt;|5|hub2;
ledgerR--&gt;|5|hub2;
ledgerR--&gt;|5|counterparty;
classDef me fill:#4287f5
classDef hub1 fill:#85e69f
classDef hub2 fill:#f242f5
classDef bob fill:#d93434</code></pre>
<p>Here <code>A</code> wishes to enter a channel with <code>B</code>, but only has a ledger channel with <code>I1</code>. However, since <code>I1</code> has a ledger channel with <code>I2</code>, and <code>I2</code> has a <a href="#fund-from-an-existing-channel">ledger channel</a> with <code>B</code>, it is indeed possible to safely fund such a channel in the following way.</p>
<ol>
<li><code>A</code> proposes a channel <code>V</code> with participants <code>A,I1,I2,B</code>. Each participant has a numerical role in the virtual funding protocol. <code>V</code> allocates funds to <code>A</code> and <code>B</code>, but not to ther intermediaries <code>I1,I2</code>. The other participants join the channel. See <a href="../0040-lifecycle-of-a-channel/">lifecycle of a channel</a>.</li>
<li>In each existing ledger channel (<code>L,M,R</code>), the participants of that channel make an update to include a guarantee for <code>V</code> in the outcome of the ledger channel.</li>
<li>When all of the ledger channels (there will be 1 or 2) which an actor is participating in have reached consensus on guaranteeing <code>V</code>, that actor signs the <a href="../0040-lifecycle-of-a-channel/#off-chain-lifecycle">postfund state</a> for <code>V</code>.</li>
<li>When the postfund round completes, the channel is considered funded.</li>
</ol>
<p>Here is an example of step 2 for <code>M</code>, the ledger channel between <code>A</code> and <code>I1</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Typescript</label><label for="__tabbed_2_2">Go</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="nx">Exit</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="nx">SingleAssetExit</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nx">NullAssetMetadata</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@statechannels/exit-format&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ethExit</span><span class="o">:</span><span class="w"> </span><span class="kt">SingleAssetExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="nx">asset</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x0&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">  </span><span class="nx">assetMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">NullAssetMetadata</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">  </span><span class="nx">allocations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x00000000000000000000000096f7123E3A80C9813eF50213ADEd0e4511CB820f&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Alice</span><span class="w"></span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x04&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
</span><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.simple</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x0000000000000000000000000737369d5F8525D039038Da1EdBAC4C4f161b949&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Bob</span><span class="w"></span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x04&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// (2)</span><span class="w"></span>
</span><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.simple</span><span class="p">,</span><span class="w"> </span><span class="c1">// a regular ETH transfer</span><span class="w"></span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">    </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="hll"><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span><span class="w"></span>
</span><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="hll"><span class="w">      </span><span class="c1">// The channel id of V:</span><span class="w"></span>
</span><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="hll"><span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x0737369d5F8C4f161b949525D039038Da1EdBAC4&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="hll"><span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x02&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="hll"><span class="w">      </span><span class="nx">allocationType</span><span class="o">:</span><span class="w"> </span><span class="kt">AllocationType.Guarantee</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="hll"><span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x00000000000000000000000096f7123E3A80C9813eF50213ADEd0e4511CB820f0000000000000000000000000737369d5F8525D039038Da1EdBAC4C4f161b949&quot;</span><span class="p">,</span><span class="w"></span>
</span><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="hll"><span class="w">    </span><span class="p">},</span><span class="w"></span>
</span><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">  </span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="kd">const</span><span class="w"> </span><span class="nx">exit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">ethExit</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<ol>
<li>This amount was decremented by 1.</li>
<li>This amount was decremented by 1.</li>
<li>This allocation was appended. Notice that it is a <a href="../0030-outcomes/#guarantees">guarantee allocation.</a></li>
</ol>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">  </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="s">&quot;math/big&quot;</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="s">&quot;github.com/ethereum/go-ethereum/common&quot;</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="s">&quot;github.com/statechannels/go-nitro/channel/state/outcome&quot;</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="s">&quot;github.com/statechannels/go-nitro/types&quot;</span><span class="w"></span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">aliceDestination</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0x00000000000000000000000096f7123E3A80C9813eF50213ADEd0e4511CB820f&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">I1Destination</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0x0000000000000000000000000737369d5F8525D039038Da1EdBAC4C4f161b949&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ethExit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">SingleAssetExit</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">      </span><span class="nx">Allocations</span><span class="p">:</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocations</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">aliceDestination</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
</span><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">I1Destination</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="c1">// (2)</span><span class="w"></span>
</span><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">        </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="hll"><span class="w">        </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Allocation</span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span><span class="w"></span>
</span><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="hll"><span class="w">          </span><span class="c1">// The channel id of V:</span><span class="w"></span>
</span><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="hll"><span class="w">          </span><span class="nx">Destination</span><span class="p">:</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToHash</span><span class="p">(</span><span class="s">&quot;0x0737369d5F8C4f161b949525D039038Da1EdBAC4&quot;</span><span class="p">)),</span><span class="w"></span>
</span><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="hll"><span class="w">          </span><span class="nx">Amount</span><span class="p">:</span><span class="w">      </span><span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"></span>
</span><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="hll"><span class="w">          </span><span class="nx">Metadata</span><span class="p">:</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">aliceDestination</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">(),</span><span class="w"> </span><span class="nx">I1Destination</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()</span><span class="o">...</span><span class="p">)</span><span class="w"></span>
</span><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="hll"><span class="w">        </span><span class="p">},</span><span class="w"></span>
</span><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">      </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">exit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">outcome</span><span class="p">.</span><span class="nx">Exit</span><span class="p">{{</span><span class="nx">ethExit</span><span class="p">}}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>This amount was decremented by 1.</li>
<li>This amount was decremented by 1.</li>
<li>This allocation was appended. Notice that it is a <a href="../0030-outcomes/#guarantees">guarantee allocation.</a></li>
</ol>
</div>
</div>
</div>
<p>Note how the additional allocation is a <a href="../0030-outcomes/#guarantees">guarantee allocation.</a> and has appropriately encoded metadata. If the ledger channels are labelled <code>L_i</code> and ordered left to right by participant role, the <code>left</code> metadata field in <code>L_i</code>'s guarantee is set to participant <code>P_i</code>'s destination and the right metadata field is set to participant <code>P_(i+1)</code>'s destiantion.</p>
<p>And once steps 1-4 are complete, the funding graph looks like so:</p>
<pre class="mermaid"><code>graph TD;
linkStyle default interpolate basis;
ETHAssetHolder( )
ledgerL((L))
ledgerM((M))
ledgerR((R))
V((V))
me((A)):::me
hub1((I1)):::hub1
hub2((I2)):::hub2
counterparty((B)):::bob
ETHAssetHolder--&gt;|10|ledgerL;
ETHAssetHolder--&gt;|10|ledgerM;
ETHAssetHolder--&gt;|10|ledgerR;
ledgerL--&gt;|4|me;
ledgerL--&gt;|4|hub1;
ledgerM--&gt;|4|hub1;
ledgerM--&gt;|4|hub2;
ledgerR--&gt;|4|hub2;
ledgerR--&gt;|4|counterparty;
ledgerL-..-&gt;|2|V;
ledgerM-..-&gt;|2|V;
ledgerR-..-&gt;|2|V;
classDef me fill:#4287f5
classDef hub1 fill:#85e69f
classDef hub2 fill:#f242f5
classDef bob fill:#d93434</code></pre>
<p>This construction generalizes, and works with anything from <code>1</code> , <code>2</code> (as shown here) or <code>n</code> hops.</p>
<p>Channel <code>V</code> may be used for <code>A</code> to send payments to <code>B</code>, for example: see <a href="../0020-execution-rules/#virtualpaymentapp">virtual payment app</a>.</p>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../0050-precautions-and-limits/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Precautions and Limits" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Precautions and Limits
            </div>
          </div>
        </a>
      
      
        
        <a href="../0070-finalizing-a-channel/" class="md-footer__link md-footer__link--next" aria-label="Next: Finalizing a channel" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Finalizing a channel
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "navigation.tracking", "navigation.tabs", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>